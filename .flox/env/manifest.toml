version = 1

[install]
# core build tools
autoconf.pkg-path = "autoconf"
automake.pkg-path = "automake"
libtool.pkg-path = "libtool"
gnumake.pkg-path = "gnumake"
pkg-config.pkg-path = "pkg-config"
zlib.pkg-path = "zlib"

# platform-specific compilers + dependencies
gcc.pkg-path = "gcc"
gcc.systems = ["x86_64-linux", "aarch64-linux"]
clang.pkg-path = "clang"
clang.systems = ["x86_64-darwin", "aarch64-darwin"]
IOKit.pkg-path = "darwin.apple_sdk.frameworks.IOKit"
IOKit.systems = ["x86_64-darwin", "aarch64-darwin"]
CoreFoundation.pkg-path = "darwin.apple_sdk.frameworks.CoreFoundation"
CoreFoundation.priority = 2
CoreFoundation.systems = ["x86_64-darwin", "aarch64-darwin"]

# audio libs
libsndfile.pkg-path = "libsndfile"
libltdl.pkg-path = "libtool"  # provides libltdl

# audio codec libs
flac.pkg-path = "flac"
lame.pkg-path = "lame"
libmad.pkg-path = "libmad"
libvorbis.pkg-path = "libvorbis"
libvorbis.priority = 3
libogg.pkg-path = "libogg"
opusfile.pkg-path = "opusfile"
gsm.pkg-path = "gsm"
wavpack.pkg-path = "wavpack"

# metadata + utility libs
libid3tag.pkg-path = "libid3tag"
file.pkg-path = "file"  # provides libmagic
gnused.pkg-path = "gnused"  # provides GNU sed for macOS

# audio i/o libs (linux only)
alsa-lib.pkg-path = "alsa-lib"
alsa-lib.systems = ["x86_64-linux", "aarch64-linux"]
libpulseaudio.pkg-path = "libpulseaudio"
libpulseaudio.systems = ["x86_64-linux", "aarch64-linux"]

# effects libs
ladspa-sdk.pkg-path = "ladspa-sdk"
ladspa-sdk.systems = ["x86_64-linux", "aarch64-linux"]

# custom ffmpeg
"barstoolbluz/ffmpeg".pkg-path = "ffmpeg"
"barstoolbluz/ffmpeg".priority = 7
"barstoolbluz/ffmpeg".systems = ["x86_64-linux"]
"barstoolbluz/ffmpeg-darwin".pkg-path = "barstoolbluz/ffmpeg-darwin"
"barstoolbluz/ffmpeg-darwin".priority = 7
"barstoolbluz/ffmpeg-darwin".systems = ["x86_64-darwin"]
ffmpeg.pkg-path = "ffmpeg"
ffmpeg.priority = 7
ffmpeg.systems = ["aarch64-darwin", "aarch64-linux"]


[build.sox_ng-linux]
description = "sox_ng: custom sox_ng with large sinc filter support (up to 1 billion taps); uses familiar 'sox' command, drop-in replacement for legacy sox"
version = "14.6.1.2-custom"
sandbox = "pure"
command = '''
set -euo pipefail
mkdir -p "$out"

# Apply large sinc filter patch
echo "Applying large sinc filter support patch..."

# 1. Increase FFT4G_MAX_SIZE in fft4g.h
echo "Patching fft4g.h to increase FFT4G_MAX_SIZE..."
sed -i 's/#define FFT4G_MAX_SIZE 262144/#define FFT4G_MAX_SIZE 1073741824/' src/fft4g.h

# 2. Increase ip array sizes in fft4g.c
echo "Patching fft4g.c to increase ip array sizes..."
sed -i 's/int j, j1, k, k1, l, m, m2, ip\[256\];/int j, j1, k, k1, l, m, m2, ip[16384];/' src/fft4g.c

# 3. Increase sinc filter tap limits
echo "Patching sinc.c to increase tap limits..."
sed -i 's/GETOPT_NUMERIC(optstate, '\''n'\'', num_taps\[1\], 11, 32767)/GETOPT_NUMERIC(optstate, '\''n'\'', num_taps[1], 11, 1073741823)/' src/sinc.c
sed -i 's/\*num_taps = range_limit(n, 11, 32767);/*num_taps = range_limit(n, 11, 1073741823);/' src/sinc.c

echo "Large sinc filter patch applied successfully!"

# Now apply the standard sox_ng -> sox renaming
sed -i 's/sox_ng/sox/g' configure.ac

sed -i 's/sox_ng/sox/g' CMakeLists.txt
sed -i 's/sox_ng/sox/g' src/CMakeLists.txt

sed -i 's/sox_ng/sox/g' Makefile.am
sed -i 's/soxi_ng/soxi/g' Makefile.am
sed -i 's/soxformat_ng/soxformat/g' Makefile.am
sed -i 's/libsox_ng/libsox/g' Makefile.am
sed -i 's/play_ng/play/g' Makefile.am
sed -i 's/rec_ng/rec/g' Makefile.am
sed -i 's/sox_ng/sox/g' src/Makefile.am
sed -i 's/libsox_ng/libsox/g' src/Makefile.am

if [ -f src/optional-fmts.am ]; then
    sed -i 's/sox_ng/sox/g' src/optional-fmts.am
    sed -i 's/libsox_ng/libsox/g' src/optional-fmts.am
fi

sed -i 's/libsox_i\.c/libsox_i.c/g' src/Makefile.am
sed -i 's/libsox_i\.c/libsox_i.c/g' src/optional-fmts.am 2>/dev/null || true

if [ -f sox_ng.pc.in ]; then
    mv sox_ng.pc.in sox.pc.in
    sed -i 's/sox_ng/sox/g' sox.pc.in
    sed -i 's/libsox_ng/libsox/g' sox.pc.in
fi

if [ -f src/sox_ng.h ]; then
    mv src/sox_ng.h src/sox.h
fi
if [ -f src/sox_ng.c ]; then
    mv src/sox_ng.c src/sox.c
fi
if [ -f src/libsox_ng.c ]; then
    mv src/libsox_ng.c src/libsox.c
fi

find src -name "*.c" -o -name "*.h" | xargs sed -i 's/sox_ng\.h/sox.h/g'
find src -name "*.c" -o -name "*.h" | xargs sed -i 's/libsox_ng/libsox/g'
find src -name "*.c" -o -name "*.h" | xargs sed -i 's/"libsox\.h"/"libsox.h"/g'
find src -name "*.c" -o -name "*.h" | xargs sed -i 's/<libsox\.h>/<libsox.h>/g'
find src -name "*.c" -o -name "*.h" | xargs sed -i 's/libsox_i/libsox_i/g'

if [ -f sox_ng.1 ]; then
    mv sox_ng.1 sox.1
    sed -i 's/sox_ng/sox/g' sox.1
    sed -i 's/play_ng/play/g' sox.1
    sed -i 's/rec_ng/rec/g' sox.1
fi
if [ -f soxi_ng.1 ]; then
    mv soxi_ng.1 soxi.1
    sed -i 's/sox_ng/sox/g' soxi.1
    sed -i 's/soxi_ng/soxi/g' soxi.1
fi
if [ -f soxformat_ng.7 ]; then
    mv soxformat_ng.7 soxformat.7
    sed -i 's/sox_ng/sox/g' soxformat.7
    sed -i 's/soxformat_ng/soxformat/g' soxformat.7
fi
if [ -f libsox_ng.3 ]; then
    mv libsox_ng.3 libsox.3
    sed -i 's/sox_ng/sox/g' libsox.3
    sed -i 's/libsox_ng/libsox/g' libsox.3
fi

find test -name "*.sh" -o -name "*.test" | xargs sed -i 's/sox_ng/sox/g' 2>/dev/null || true
find test -name "*.sh" -o -name "*.test" | xargs sed -i 's/soxi_ng/soxi/g' 2>/dev/null || true
find test -name "*.sh" -o -name "*.test" | xargs sed -i 's/play_ng/play/g' 2>/dev/null || true
find test -name "*.sh" -o -name "*.test" | xargs sed -i 's/rec_ng/rec/g' 2>/dev/null || true

for script in mingwbuild osxbuild release.sh; do
    if [ -f "$script" ]; then
        sed -i 's/sox_ng/sox/g' "$script"
        sed -i 's/soxi_ng/soxi/g' "$script"
        sed -i 's/libsox_ng/libsox/g' "$script"
        sed -i 's/play_ng/play/g' "$script"
        sed -i 's/rec_ng/rec/g' "$script"
    fi
done

if ! grep -q "math.h" src/sox_sample_test.h; then
    echo "Adding math.h include to src/sox_sample_test.h"
    sed -i '/^#include <assert.h>$/a #include <math.h>' src/sox_sample_test.h
else
    echo "math.h include already present"
fi

autoreconf -fiv

./configure \
    --prefix="$out" \
    --enable-shared \
    --enable-static \
    --with-ffmpeg

make -j$(nproc)

make install

cd "$out/bin"
if [ -L play_ng ]; then
    rm play_ng
    ln -s sox play
fi
if [ -L rec_ng ]; then
    rm rec_ng
    ln -s sox rec
fi
if [ -L soxi_ng ]; then
    rm soxi_ng
    ln -s sox soxi
fi
'''


[build.sox_ng-darwin]
description = "sox_ng: custom sox_ng with large sinc filter support (up to 1 billion taps); uses familiar 'sox' command, drop-in replacement for legacy sox"
version = "14.6.1.2-custom"
command = '''
set -euo pipefail
mkdir -p "$out"

# Apply large sinc filter patch
echo "Applying large sinc filter support patch..."

# 1. Increase FFT4G_MAX_SIZE in fft4g.h
echo "Patching fft4g.h to increase FFT4G_MAX_SIZE..."
sed -i 's/#define FFT4G_MAX_SIZE 262144/#define FFT4G_MAX_SIZE 1073741824/' src/fft4g.h

# 2. Increase ip array sizes in fft4g.c
echo "Patching fft4g.c to increase ip array sizes..."
sed -i 's/int j, j1, k, k1, l, m, m2, ip\[256\];/int j, j1, k, k1, l, m, m2, ip[16384];/' src/fft4g.c

# 3. Increase sinc filter tap limits
echo "Patching sinc.c to increase tap limits..."
sed -i 's/GETOPT_NUMERIC(optstate, '\''n'\'', num_taps\[1\], 11, 32767)/GETOPT_NUMERIC(optstate, '\''n'\'', num_taps[1], 11, 1073741823)/' src/sinc.c
sed -i 's/\*num_taps = range_limit(n, 11, 32767);/*num_taps = range_limit(n, 11, 1073741823);/' src/sinc.c

echo "Large sinc filter patch applied successfully!"

echo "Renaming sox_ng to sox throughout the codebase..."

sed -i 's/sox_ng/sox/g' configure.ac

sed -i 's/sox_ng/sox/g' CMakeLists.txt
sed -i 's/sox_ng/sox/g' src/CMakeLists.txt

sed -i 's/sox_ng/sox/g' Makefile.am
sed -i 's/soxi_ng/soxi/g' Makefile.am
sed -i 's/soxformat_ng/soxformat/g' Makefile.am
sed -i 's/libsox_ng/libsox/g' Makefile.am
sed -i 's/play_ng/play/g' Makefile.am
sed -i 's/rec_ng/rec/g' Makefile.am
sed -i 's/sox_ng/sox/g' src/Makefile.am
sed -i 's/libsox_ng/libsox/g' src/Makefile.am

if [ -f src/optional-fmts.am ]; then
    sed -i 's/sox_ng/sox/g' src/optional-fmts.am
    sed -i 's/libsox_ng/libsox/g' src/optional-fmts.am
fi

sed -i 's/libsox_i\.c/libsox_i.c/g' src/Makefile.am
sed -i 's/libsox_i\.c/libsox_i.c/g' src/optional-fmts.am 2>/dev/null || true

if [ -f sox_ng.pc.in ]; then
    mv sox_ng.pc.in sox.pc.in
    sed -i 's/sox_ng/sox/g' sox.pc.in
    sed -i 's/libsox_ng/libsox/g' sox.pc.in
fi

if [ -f src/sox_ng.h ]; then
    mv src/sox_ng.h src/sox.h
fi
if [ -f src/sox_ng.c ]; then
    mv src/sox_ng.c src/sox.c
fi
if [ -f src/libsox_ng.c ]; then
    mv src/libsox_ng.c src/libsox.c
fi

find src -name "*.c" -o -name "*.h" | xargs sed -i 's/sox_ng\.h/sox.h/g'
find src -name "*.c" -o -name "*.h" | xargs sed -i 's/libsox_ng/libsox/g'
find src -name "*.c" -o -name "*.h" | xargs sed -i 's/"libsox\.h"/"libsox.h"/g'
find src -name "*.c" -o -name "*.h" | xargs sed -i 's/<libsox\.h>/<libsox.h>/g'
find src -name "*.c" -o -name "*.h" | xargs sed -i 's/libsox_i/libsox_i/g'

if [ -f sox_ng.1 ]; then
    mv sox_ng.1 sox.1
    sed -i 's/sox_ng/sox/g' sox.1
    sed -i 's/play_ng/play/g' sox.1
    sed -i 's/rec_ng/rec/g' sox.1
fi
if [ -f soxi_ng.1 ]; then
    mv soxi_ng.1 soxi.1
    sed -i 's/sox_ng/sox/g' soxi.1
    sed -i 's/soxi_ng/soxi/g' soxi.1
fi
if [ -f soxformat_ng.7 ]; then
    mv soxformat_ng.7 soxformat.7
    sed -i 's/sox_ng/sox/g' soxformat.7
    sed -i 's/soxformat_ng/soxformat/g' soxformat.7
fi
if [ -f libsox_ng.3 ]; then
    mv libsox_ng.3 libsox.3
    sed -i 's/sox_ng/sox/g' libsox.3
    sed -i 's/libsox_ng/libsox/g' libsox.3
fi

find test -name "*.sh" -o -name "*.test" | xargs sed -i 's/sox_ng/sox/g' 2>/dev/null || true
find test -name "*.sh" -o -name "*.test" | xargs sed -i 's/soxi_ng/soxi/g' 2>/dev/null || true
find test -name "*.sh" -o -name "*.test" | xargs sed -i 's/play_ng/play/g' 2>/dev/null || true
find test -name "*.sh" -o -name "*.test" | xargs sed -i 's/rec_ng/rec/g' 2>/dev/null || true

for script in mingwbuild osxbuild release.sh; do
    if [ -f "$script" ]; then
        sed -i 's/sox_ng/sox/g' "$script"
        sed -i 's/soxi_ng/soxi/g' "$script"
        sed -i 's/libsox_ng/libsox/g' "$script"
        sed -i 's/play_ng/play/g' "$script"
        sed -i 's/rec_ng/rec/g' "$script"
    fi
done

echo "Checking and fixing math.h include if needed..."
if ! grep -q "math.h" src/sox_sample_test.h; then
    echo "Adding math.h include to src/sox_sample_test.h"
    sed -i '/^#include <assert.h>$/a #include <math.h>' src/sox_sample_test.h
else
    echo "math.h include already present"
fi

echo "Searching and fixing function pointer type compatibility issues..."
if [[ "$OSTYPE" == "darwin"* ]]; then
    find src -name "*.c" -exec grep -l "uint64_t.*offset" {} \; | while read file; do
        echo "Patching $file..."
        sed -i 's/uint64_t \([A-Z_]*\) offset/sox_uint64_t \1 offset/g' "$file"
    done
    
    echo "Fixing lsx_rawseek function signatures..."
    sed -i 's/int lsx_rawseek(sox_format_t \* ft, uint64_t offset)/int lsx_rawseek(sox_format_t * ft, sox_uint64_t offset)/g' src/sox_i.h
    sed -i 's/int lsx_rawseek(sox_format_t \* ft, uint64_t offset)/int lsx_rawseek(sox_format_t * ft, sox_uint64_t offset)/g' src/raw.c
    
    find src -name "*.c" -exec grep -l "uint64_t" {} \; | while read file; do
        echo "Final cleanup of uint64_t types in $file..."
        sed -i 's/(\(sox_format_t[^,]*\), uint64_t/(\1, sox_uint64_t/g' "$file"
    done
else
    echo "Not on macOS, skipping function pointer type fixes"
fi

autoreconf -fiv

./configure \
    --prefix="$out" \
    --enable-shared \
    --enable-static \
    --with-ffmpeg

make -j$(nproc)

make install

cd "$out/bin"
if [ -L play_ng ]; then
    rm play_ng
    ln -s sox play
fi
if [ -L rec_ng ]; then
    rm rec_ng
    ln -s sox rec
fi
if [ -L soxi_ng ]; then
    rm soxi_ng
    ln -s sox soxi
fi
'''

[profile]
common = '''
# ═══════════════════════════════════════════════════════════════════════════
# Publishing Helper Functions for sox_ng
# ═══════════════════════════════════════════════════════════════════════════
# Usage: flox activate, then run these functions interactively
#
# Quick start:
#   list_publishable              - Show what can be published
#   check_publish_ready           - Pre-flight validation
#   publish_sox <org> <package>   - Publish to organization
#   publish_to_flox <package>     - Quick shortcut for flox org
# ═══════════════════════════════════════════════════════════════════════════

# List all publishable packages with versions
list_publishable() {
  echo "═══════════════════════════════════════════════════════════════"
  echo "Publishable sox_ng Packages"
  echo "═══════════════════════════════════════════════════════════════"
  echo ""
  echo "Manifest Builds (platform-specific):"
  echo "  • sox_ng-linux  (14.6.1.2-custom) - Linux x86_64/aarch64"
  echo "  • sox_ng-darwin (14.6.1.2-custom) - macOS x86_64/aarch64"
  echo ""
  echo "Nix Expression Build (cross-platform):"
  echo "  • sox_ng        (14.6.1.2-custom) - Via .flox/pkgs/sox_ng.nix"
  echo ""
  echo "Usage:"
  echo "  publish_sox <org> <package>     - Publish to specified org"
  echo "  publish_to_flox <package>       - Publish to flox org"
  echo "  publish_all <org>               - Publish all three packages"
  echo ""
  echo "Examples:"
  echo "  publish_sox barstoolbluz sox_ng-linux"
  echo "  publish_to_flox sox_ng"
  echo "  publish_all barstoolbluz"
  echo "═══════════════════════════════════════════════════════════════"
}

# Check if environment is ready for publishing
check_publish_ready() {
  local ready=0
  
  echo "═══════════════════════════════════════════════════════════════"
  echo "Pre-Publish Validation"
  echo "═══════════════════════════════════════════════════════════════"
  echo ""
  
  # Check git status
  if ! git diff-index --quiet HEAD -- 2>/dev/null; then
    echo "✗ Git status: Uncommitted changes detected"
    echo "  → Commit and push all changes before publishing"
    ready=1
  else
    echo "✓ Git status: Clean working tree"
  fi
  
  # Check if latest commit is pushed
  local unpushed=$(git log @{u}.. --oneline 2>/dev/null | wc -l)
  if [ "$unpushed" -gt 0 ]; then
    echo "✗ Commits: $unpushed unpushed commit(s)"
    echo "  → Run: git push origin main"
    ready=1
  else
    echo "✓ Commits: All pushed to remote"
  fi
  
  # Check versions are synchronized
  local src_ver=$(grep "AC_INIT" configure.ac 2>/dev/null | grep -oP '\[\K[0-9.]+' | head -1)
  local nix_ver=$(grep 'version = ' .flox/pkgs/sox_ng.nix 2>/dev/null | head -1 | grep -oP '"\K[^"]+')
  local manifest_ver=$(grep 'version = "14' .flox/env/manifest.toml 2>/dev/null | head -1 | grep -oP '"\K[^"]+')
  
  if [ "$src_ver" = "14.6.1.2" ] && [ "$nix_ver" = "14.6.1.2-custom" ] && [ "$manifest_ver" = "14.6.1.2-custom" ]; then
    echo "✓ Versions: Synchronized (14.6.1.2-custom)"
  else
    echo "✗ Versions: Mismatch detected"
    echo "  Source: $src_ver"
    echo "  Nix:    $nix_ver"
    echo "  Manifest: $manifest_ver"
    ready=1
  fi
  
  # Check authentication (best effort)
  if ! flox whoami >/dev/null 2>&1; then
    echo "⚠ Auth: Not logged in"
    echo "  → Run: flox auth login"
    ready=1
  else
    local user=$(flox whoami 2>/dev/null)
    echo "✓ Auth: Logged in as $user"
  fi
  
  echo ""
  if [ $ready -eq 0 ]; then
    echo "✓ Ready to publish!"
    return 0
  else
    echo "✗ Not ready - resolve issues above first"
    return 1
  fi
}

# Main publishing function
# Usage: publish_sox <org> <package>
# Example: publish_sox barstoolbluz sox_ng-linux
publish_sox() {
  local org="${1:-}"
  local package="${2:-}"
  
  # Validate arguments
  if [ -z "$org" ]; then
    echo "Error: Organization not specified"
    echo ""
    echo "Usage: publish_sox <org> <package>"
    echo ""
    echo "Examples:"
    echo "  publish_sox barstoolbluz sox_ng-linux"
    echo "  publish_sox flox sox_ng-darwin"
    echo "  publish_sox myorg sox_ng"
    echo ""
    echo "Available packages:"
    echo "  sox_ng-linux, sox_ng-darwin, sox_ng"
    return 1
  fi
  
  if [ -z "$package" ]; then
    echo "Error: Package not specified"
    echo ""
    echo "Usage: publish_sox <org> <package>"
    echo ""
    list_publishable
    return 1
  fi
  
  # Validate package name
  case "$package" in
    sox_ng-linux|sox_ng-darwin|sox_ng)
      : # valid
      ;;
    *)
      echo "Error: Unknown package '$package'"
      echo ""
      echo "Valid packages: sox_ng-linux, sox_ng-darwin, sox_ng"
      return 1
      ;;
  esac
  
  # Run pre-flight checks
  echo "Running pre-flight checks..."
  echo ""
  if ! check_publish_ready; then
    echo ""
    echo "Aborting publish. Fix issues above first."
    return 1
  fi
  
  # Confirm with user
  echo ""
  echo "═══════════════════════════════════════════════════════════════"
  echo "Ready to Publish"
  echo "═══════════════════════════════════════════════════════════════"
  echo "  Package:      $package"
  echo "  Organization: $org"
  echo "  Result:       $org/$package"
  echo ""
  read -p "Proceed with publish? [y/N] " -n 1 -r
  echo ""
  
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Publish cancelled."
    return 1
  fi
  
  echo ""
  echo "Publishing $package to organization: $org"
  echo "═══════════════════════════════════════════════════════════════"
  echo ""
  
  # Execute publish
  if flox publish -o "$org" "$package"; then
    echo ""
    echo "✓ Successfully published!"
    echo ""
    echo "Package available as: $org/$package"
    echo ""
    echo "Install with: flox install $org/$package"
  else
    echo ""
    echo "✗ Publish failed. Check errors above."
    return 1
  fi
}

# Quick shortcut to publish to flox organization
# Usage: publish_to_flox <package>
# Example: publish_to_flox sox_ng-linux
publish_to_flox() {
  local package="${1:-}"
  
  if [ -z "$package" ]; then
    echo "Error: Package not specified"
    echo ""
    echo "Usage: publish_to_flox <package>"
    echo ""
    echo "Examples:"
    echo "  publish_to_flox sox_ng-linux"
    echo "  publish_to_flox sox_ng-darwin"
    echo "  publish_to_flox sox_ng"
    return 1
  fi
  
  publish_sox "flox" "$package"
}

# Publish all three packages to specified organization
# Usage: publish_all <org>
# Example: publish_all barstoolbluz
publish_all() {
  local org="${1:-barstoolbluz}"
  
  echo "═══════════════════════════════════════════════════════════════"
  echo "Publishing All Packages to: $org"
  echo "═══════════════════════════════════════════════════════════════"
  echo ""
  echo "This will publish:"
  echo "  1. sox_ng-linux"
  echo "  2. sox_ng-darwin"
  echo "  3. sox_ng"
  echo ""
  echo "To organization: $org"
  echo ""
  read -p "Continue? [y/N] " -n 1 -r
  echo ""
  
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Cancelled."
    return 1
  fi
  
  local packages=("sox_ng-linux" "sox_ng-darwin" "sox_ng")
  local failed=0
  
  for pkg in "${packages[@]}"; do
    echo ""
    echo "───────────────────────────────────────────────────────────────"
    echo "Publishing: $pkg"
    echo "───────────────────────────────────────────────────────────────"
    
    # Non-interactive publish for batch
    if flox publish -o "$org" "$pkg"; then
      echo "✓ $pkg published successfully"
    else
      echo "✗ $pkg publish failed"
      failed=$((failed + 1))
      
      read -p "Continue with remaining packages? [y/N] " -n 1 -r
      echo ""
      if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Stopped at $pkg"
        return 1
      fi
    fi
  done
  
  echo ""
  echo "═══════════════════════════════════════════════════════════════"
  if [ $failed -eq 0 ]; then
    echo "✓ All packages published successfully!"
    echo ""
    echo "Available as:"
    echo "  $org/sox_ng-linux"
    echo "  $org/sox_ng-darwin"
    echo "  $org/sox_ng"
  else
    echo "⚠ Completed with $failed failure(s)"
  fi
  echo "═══════════════════════════════════════════════════════════════"
}

# Show what's currently published (requires catalog search)
show_published() {
  local org="${1:-barstoolbluz}"
  
  echo "Searching for published sox_ng packages from: $org"
  echo ""
  
  flox search "$org/sox" 2>/dev/null || {
    echo "No packages found or search unavailable."
    echo ""
    echo "Try: flox search $org/"
  }
}

# Helper: Show quick usage
sox_publish_help() {
  echo "═══════════════════════════════════════════════════════════════"
  echo "Sox_ng Publishing Helper Functions"
  echo "═══════════════════════════════════════════════════════════════"
  echo ""
  echo "Available commands:"
  echo "  list_publishable              - List all publishable packages"
  echo "  check_publish_ready           - Validate prerequisites"
  echo "  publish_sox <org> <pkg>       - Publish to organization"
  echo "  publish_to_flox <pkg>         - Publish to flox org"
  echo "  publish_all <org>             - Publish all packages"
  echo "  show_published <org>          - Search published packages"
  echo "  sox_publish_help              - Show this help"
  echo ""
  echo "Quick examples:"
  echo "  publish_sox barstoolbluz sox_ng-linux"
  echo "  publish_to_flox sox_ng"
  echo "  publish_all barstoolbluz"
  echo ""
  echo "For details: list_publishable"
  echo "═══════════════════════════════════════════════════════════════"
}

# Show help on activation
echo ""
echo "sox_ng publishing helpers loaded. Type 'sox_publish_help' for usage."
echo ""
'''
